<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pulse Monitor v2.4</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pulse">

    <link rel="icon" id="dynamic-favicon">
    <link rel="apple-touch-icon" id="dynamic-apple-icon">
    <link rel="manifest" id="dynamic-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-200: #e2e8f0;
            --sky-400: #38bdf8;
            --sky-500: #0ea5e9;
            --sky-600: #0284c7;
            --sky-700: #0369a1;
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --red-500: #ef4444;
            --amber-500: #f59e0b;
            --amber-700: #b45309;
            --rose-400: #fb7185;
            --rose-500: #f43f5e;
        }
        body {
            background-color: var(--slate-900);
            color: var(--slate-200);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow: hidden; 
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }
        .pixelated { 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges; 
            image-rendering: crisp-edges; 
        }
        .hidden-vid { 
            display: none; 
        }
        .scroller::-webkit-scrollbar { 
            width: 4px; 
        }
        .scroller::-webkit-scrollbar-track { 
            background: rgba(30, 41, 59, 0.3); 
        }
        .scroller::-webkit-scrollbar-thumb { 
            background: var(--slate-600); 
            border-radius: 2px; 
        }
        .control-panel {
            backdrop-filter: blur(12px);
            background-color: rgba(15, 23, 42, 0.92);
            padding-bottom: env(safe-area-inset-bottom);
        }
        input[type=range].scrubber {
            -webkit-appearance: none; 
            background: transparent;
        }
        input[type=range].scrubber::-webkit-slider-runnable-track {
            height: 6px; 
            background: var(--slate-700); 
            border-radius: 3px;
        }
        input[type=range].scrubber::-webkit-slider-thumb {
            -webkit-appearance: none; 
            height: 18px; 
            width: 18px;
            border-radius: 50%; 
            background: var(--sky-400); 
            margin-top: -6px;
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle-checkbox:checked { 
            right: 0; 
            border-color: var(--sky-400); 
        }
        .toggle-checkbox:checked + .toggle-label { 
            background-color: var(--sky-400); 
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div class="flex-none pt-safe-top px-4 pb-2 flex justify-between items-center bg-slate-900/80 border-b border-slate-700/50 z-10 backdrop-blur-md">
        <div class="flex flex-col pt-2">
            <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Heart Rate</span>
            <div class="flex items-baseline gap-2">
                <span id="bpmDisplay" class="text-4xl font-mono font-bold text-slate-500 tracking-tighter">--</span>
                <span id="modeBadge" class="text-[10px] px-1.5 py-0.5 rounded border border-slate-700 text-slate-400 font-bold uppercase">Idle</span>
            </div>
        </div>
        
        <div class="text-right flex flex-col items-end pt-2 gap-1">
             <div class="flex items-center gap-2">
                 <canvas id="previewCanvas" width="30" height="30" class="w-8 h-8 rounded border border-slate-600 bg-black hidden pixelated"></canvas>
                 <div id="beatIndicator" class="w-3 h-3 rounded-full bg-slate-800 transition-colors duration-75 inline-block"></div>
                 <button id="settingsBtn" class="p-1 text-slate-400 hover:text-white transition-colors text-xl">⚙</button>
             </div>
             <div class="flex items-center gap-2 mt-1">
                 <div id="wakeLockIndicator" class="hidden text-[9px] text-amber-500 font-bold flex items-center gap-1 opacity-80">
                    <span class="text-sm">☀</span>
                    <span>AWAKE</span>
                 </div>
                 <span id="storageInfo" class="text-[9px] font-mono text-slate-600">--</span>
             </div>
        </div>
    </div>

    <div class="flex-grow relative bg-black overflow-hidden group" id="canvasContainer">
        <canvas id="ppgCanvas"></canvas>
        <video id="videoElement" playsinline class="hidden-vid"></video>
        
        <div id="instructionOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none bg-black/60 z-10 transition-opacity duration-300">
            <div class="text-center p-6 max-w-sm">
                <div class="text-slate-200 font-bold text-lg mb-2">Ready to Measure</div>
                <p class="text-slate-400 text-sm">Select a mode below.</p>
                <div class="mt-4 text-xs text-slate-500 border border-slate-700 rounded p-2 bg-slate-900/50">
                    <span class="font-bold text-sky-400">Camera Mode:</span> Cover the back camera & flash gently with your fingertip.
                </div>
            </div>
        </div>

        <div id="saturationWarning" class="hidden absolute top-4 left-0 right-0 text-center pointer-events-none">
            <span class="bg-rose-900/90 text-white text-[10px] font-bold px-3 py-1 rounded-full border border-rose-500 shadow-lg">⚠️ SIGNAL CLIPPING - Move finger slightly</span>
        </div>
        
        <div id="torchWarning" class="hidden absolute top-12 left-0 right-0 text-center pointer-events-none">
            <span class="bg-amber-900/90 text-white text-[10px] font-bold px-3 py-1 rounded-full border border-amber-500 shadow-lg">⚠️ Camera flash unavailable - Ensure good lighting</span>
        </div>

        <div class="absolute bottom-2 right-2 text-[9px] font-mono text-slate-600 pointer-events-none hidden sm:block">
            Gain: <span id="debugGain">1.0</span>x
        </div>

        <div id="reviewControls" class="absolute bottom-4 left-4 right-4 bg-slate-800/95 p-4 rounded-xl border border-slate-600/50 hidden flex-col gap-3 z-20 shadow-2xl backdrop-blur-xl">
            <div class="flex justify-between text-xs text-slate-300 font-bold">
                <span>Timeline</span>
                <span id="reviewTimeDisplay" class="font-mono text-sky-400">Live</span>
            </div>
            <input type="range" id="historySlider" min="0" max="100" value="100" class="w-full scrubber accent-sky-500">
            <div class="grid grid-cols-2 gap-3 mt-1">
                <button id="exportImgBtn" class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg text-xs transition-colors border border-slate-600">
                    Save Graph Img
                </button>
                <button id="backToLiveBtn" class="py-2.5 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-lg text-xs transition-colors shadow-lg shadow-sky-900/20">
                    Done
                </button>
            </div>
        </div>
    </div>

    <div class="flex-none flex flex-col h-[35vh] min-h-[240px] control-panel border-t border-slate-700/50 z-20">
        <div class="p-3 border-b border-slate-700/50 flex flex-col gap-3">
            <div class="grid grid-cols-3 gap-2">
                <button id="cameraToggleBtn" class="h-11 bg-sky-600 hover:bg-sky-500 active:bg-sky-700 text-white font-bold rounded-lg shadow-lg shadow-sky-900/20 flex flex-col items-center justify-center text-xs transition-all">
                    Camera
                </button>
                <button id="simulateBtn" class="h-11 bg-purple-600 hover:bg-purple-500 active:bg-purple-700 text-white font-bold rounded-lg shadow-lg shadow-purple-900/20 flex flex-col items-center justify-center text-xs transition-all">
                    Simulate
                </button>
                <button id="saveBtn" class="h-11 bg-slate-700 hover:bg-slate-600 active:bg-slate-800 text-white font-bold rounded-lg border border-slate-600 flex flex-col items-center justify-center text-xs transition-all disabled:opacity-40" disabled>
                    Save
                </button>
            </div>
            <div id="simControls" class="hidden bg-slate-800/80 p-2.5 rounded-lg border border-slate-700">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-purple-400 uppercase tracking-wider">Sim Rate</label>
                    <span id="targetBpmValue" class="text-[10px] font-mono bg-purple-900/50 text-purple-200 px-1.5 py-0.5 rounded">75</span>
                </div>
                <input type="range" id="bpmSlider" min="40" max="220" value="75" class="w-full h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
            </div>
        </div>

        <div class="px-4 py-2 bg-slate-800/50 text-[10px] font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center backdrop-blur-sm">
            <span>Recent History</span>
            <div class="flex gap-2">
                <button id="deleteOldestBtn" class="text-rose-400 hover:text-white p-1" title="Delete Oldest 10">
                    Del Oldest
                </button>
                <button id="exportJsonBtn" class="text-sky-400 hover:text-white p-1" title="Download JSON">
                    Export All ⬇
                </button>
            </div>
        </div>

        <div id="savedListContainer" class="flex-grow overflow-y-auto scroller p-2 space-y-1.5 pb-safe-bottom">
            <div class="text-center text-slate-600 text-xs py-8 italic" id="emptyState">No saved records</div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-800 w-11/12 max-w-sm rounded-xl border border-slate-600 shadow-2xl p-5 transform transition-all duration-200 scale-95 opacity-0" id="settingsContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-slate-100 font-bold text-lg">Settings</h3>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-white text-2xl leading-none">✕</button>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">Camera Preview</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="settingPreview" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="settingPreview" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">
                        Auto-Stop (seconds)
                        <span class="block text-[10px] text-slate-500">0 = Manual stop</span>
                    </label>
                    <input type="number" id="settingAutoStop" min="0" max="300" class="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm text-white focus:border-sky-500 outline-none">
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">
                        BPM Averaging (Beats)
                        <span class="block text-[10px] text-slate-500">How many beats to average</span>
                    </label>
                    <input type="number" id="settingBpmWindow" min="2" max="50" class="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm text-white focus:border-sky-500 outline-none">
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">
                        Max Recordings
                        <span class="block text-[10px] text-slate-500">0 = No limit (until full)</span>
                    </label>
                    <input type="number" id="settingMaxRecords" min="0" max="1000" class="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm text-white focus:border-sky-500 outline-none">
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">Auto-Save on Stop</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="settingAutoSave" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="settingAutoSave" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>

                <div class="border-t border-slate-700 pt-3 mt-2">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Camera Specs</h4>
                    <div id="cameraStats" class="grid grid-cols-2 gap-2 text-[10px] font-mono text-slate-400">
                        <div class="bg-slate-900 p-1.5 rounded">Res: <span id="statRes" class="text-slate-200">--</span></div>
                        <div class="bg-slate-900 p-1.5 rounded">FPS: <span id="statFps" class="text-slate-200">--</span></div>
                        <div class="bg-slate-900 p-1.5 rounded">Exp: <span id="statExp" class="text-slate-200">--</span></div>
                        <div class="bg-slate-900 p-1.5 rounded">ISO: <span id="statIso" class="text-slate-200">--</span></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center">
                <span class="text-[10px] text-slate-600 font-mono">Pulse Monitor v2.4</span>
            </div>
        </div>
    </div>

<script>
// ============================================================================
// PWA Setup
// ============================================================================
(function() {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='#0f172a'/><path d='M256 448l-30-30C118 322 48 250 48 162 48 90 106 32 178 32c40 0 78 22 96 56 18-34 56-56 96-56 72 0 130 58 130 130 0 88-70 160-178 256l-30 30z' fill='#ef4444'/></svg>`;
    const url = "data:image/svg+xml;base64," + btoa(svg);
    
    document.getElementById('dynamic-favicon').href = url;
    document.getElementById('dynamic-apple-icon').href = url;
    
    const manifest = {
        name: "Pulse Monitor",
        short_name: "Pulse",
        start_url: ".",
        display: "standalone",
        background_color: "#0f172a",
        theme_color: "#0f172a",
        orientation: "portrait",
        icons: [{src: url, sizes: "512x512", type: "image/svg+xml"}]
    };
    
    document.getElementById('dynamic-manifest').href = 
        "data:application/manifest+json;base64," + btoa(JSON.stringify(manifest));
})();

// ============================================================================
// Wake Lock
// ============================================================================
let wakeLock = null;
const wakeLockIndicator = document.getElementById('wakeLockIndicator');

async function acquireWakeLock() {
    if ('wakeLock' in navigator && !wakeLock) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLockIndicator.classList.remove('hidden');
            
            wakeLock.addEventListener('release', () => {
                wakeLock = null;
                wakeLockIndicator.classList.add('hidden');
            });
        } catch (err) {
            console.warn('Wake Lock error', err);
        }
    }
}

async function releaseWakeLock() {
    if (wakeLock) {
        try {
            await wakeLock.release();
        } catch(e) {
            console.warn('Wake Lock release error', e);
        }
        wakeLock = null;
        wakeLockIndicator.classList.add('hidden');
    }
}

// ============================================================================
// Settings & State
// ============================================================================
const cfg = {
    showPreview: false,
    autoStopSeconds: 0,
    bpmCalculationWindow: 8,
    autoSave: false,
    maxRecords: 50
};

const state = {
    mode: 'idle',
    lastTime: 0,
    totalTime: 0,
    history: [],
    reviewOffset: 0,
    signalMean: 0,
    framesSinceStart: 0,
    recentValues: [],
    currentGain: 1.0,
    simPhase: 0,
    simBpm: 75
};

let reviewData = null;

const session = {
    id: null,
    startTime: null
};

const algo = {
    lastBeatTime: 0,
    refractoryPeriod: 250,
    runningMax: 0.1,
    threshold: 0.05,
    decayRate: 0.99,
    detectedBeats: [],
    bpm: 0
};

// ============================================================================
// DOM Elements
// ============================================================================
const $ = id => document.getElementById(id);

const els = {
    video: $('videoElement'),
    canvas: $('ppgCanvas'),
    preview: $('previewCanvas'),
    container: $('canvasContainer'),
    bpmDisplay: $('bpmDisplay'),
    beatIndicator: $('beatIndicator'),
    modeBadge: $('modeBadge'),
    instructionOverlay: $('instructionOverlay'),
    saturationWarning: $('saturationWarning'),
    torchWarning: $('torchWarning'),
    cameraBtn: $('cameraToggleBtn'),
    simulateBtn: $('simulateBtn'),
    simControls: $('simControls'),
    bpmSlider: $('bpmSlider'),
    targetBpmValue: $('targetBpmValue'),
    debugGain: $('debugGain'),
    saveBtn: $('saveBtn'),
    savedList: $('savedListContainer'),
    reviewControls: $('reviewControls'),
    historySlider: $('historySlider'),
    backToLiveBtn: $('backToLiveBtn'),
    reviewTimeDisplay: $('reviewTimeDisplay'),
    emptyState: $('emptyState'),
    storageInfo: $('storageInfo'),
    exportJsonBtn: $('exportJsonBtn'),
    exportImgBtn: $('exportImgBtn'),
    deleteOldestBtn: $('deleteOldestBtn'),
    settingsBtn: $('settingsBtn'),
    settingsModal: $('settingsModal'),
    settingsContent: $('settingsContent'),
    closeSettingsBtn: $('closeSettingsBtn'),
    settingPreview: $('settingPreview'),
    settingAutoStop: $('settingAutoStop'),
    settingAutoSave: $('settingAutoSave'),
    settingBpmWindow: $('settingBpmWindow'),
    settingMaxRecords: $('settingMaxRecords'),
    statRes: $('statRes'),
    statFps: $('statFps'),
    statExp: $('statExp'),
    statIso: $('statIso')
};

const ctx = els.canvas.getContext('2d');
const offCtx = els.preview.getContext('2d', { willReadFrequently: true });

let stream = null;
let animationFrameId = null;

// ============================================================================
// Mode Configuration
// ============================================================================
const modeConfig = {
    idle: {
        badge: {
            text: "IDLE",
            class: "text-[10px] px-1.5 py-0.5 rounded border border-slate-700 text-slate-400 font-bold uppercase"
        },
        camera: {
            bg: ['bg-sky-600', 'hover:bg-sky-500'],
            rm: ['bg-rose-600', 'hover:bg-rose-500']
        },
        simulate: {
            bg: ['bg-purple-600', 'hover:bg-purple-500'],
            rm: ['bg-rose-600', 'hover:bg-rose-500']
        }
    },
    camera: {
        badge: {
            text: "CAMERA",
            class: "text-[10px] px-1.5 py-0.5 rounded bg-sky-900/50 border border-sky-700 text-sky-300 font-bold uppercase"
        },
        camera: {
            bg: ['bg-rose-600', 'hover:bg-rose-500'],
            rm: ['bg-sky-600', 'hover:bg-sky-500']
        }
    },
    simulate: {
        badge: {
            text: "SIM",
            class: "text-[10px] px-1.5 py-0.5 rounded bg-purple-900/50 border border-purple-700 text-purple-300 font-bold uppercase"
        },
        simulate: {
            bg: ['bg-rose-600', 'hover:bg-rose-500'],
            rm: ['bg-purple-600', 'hover:bg-purple-500']
        }
    },
    review: {
        badge: {
            text: "REVIEW",
            class: "text-[10px] px-1.5 py-0.5 rounded bg-amber-900/50 border border-amber-700 text-amber-300 font-bold uppercase"
        }
    }
};

// ============================================================================
// Helper Functions
// ============================================================================
const toggleClasses = (el, add, remove) => {
    if (remove) el.classList.remove(...remove);
    if (add) el.classList.add(...add);
};

// ============================================================================
// Shared Algorithm Functions
// ============================================================================
function calculateThreshold(samples) {
    const decayRate = algo.decayRate;
    let runningMax = 0.1;
    const results = [];
    
    samples.forEach(val => {
        runningMax *= decayRate;
        if (val > runningMax) runningMax = val;
        
        const threshold = Math.max(runningMax * 0.5, 0.05);
        results.push({ threshold, runningMax });
    });
    
    return results;
}

function detectBeats(samples, thresholds, timestamps = null) {
    const beatIndices = [];
    let lastBeatIndex = -1000;
    const minGap = 15;
    
    samples.forEach((val, i) => {
        const { threshold, runningMax } = thresholds[i];
        
        if (val > threshold && 
            (i - lastBeatIndex) > minGap && 
            runningMax > 0.15) {
            beatIndices.push(i);
            lastBeatIndex = i;
        }
    });
    
    return beatIndices;
}

function calculateBPM(beatIndices, samples, timestamps, windowSize = 8) {
    if (beatIndices.length < 2 || !timestamps) return null;
    
    const recent = beatIndices.slice(-windowSize);
    if (recent.length < 2) return null;
    
    const firstTime = timestamps[recent[0]];
    const lastTime = timestamps[recent[recent.length - 1]];
    const timeSpan = lastTime - firstTime;
    
    if (timeSpan <= 0) return null;
    
    const bpm = 60 * (recent.length - 1) / timeSpan;
    return Math.round(bpm);
}

// ============================================================================
// Settings Management
// ============================================================================
function loadSettings() {
    const saved = localStorage.getItem('pulse_settings');
    if (saved) {
        try {
            Object.assign(cfg, JSON.parse(saved));
        } catch(e) {
            console.error('Failed to load settings', e);
        }
    }
    
    els.settingPreview.checked = cfg.showPreview;
    els.settingAutoStop.value = cfg.autoStopSeconds;
    els.settingAutoSave.checked = cfg.autoSave;
    els.settingBpmWindow.value = cfg.bpmCalculationWindow;
    els.settingMaxRecords.value = cfg.maxRecords;
    
    togglePreview();
}

function saveSettings() {
    cfg.showPreview = els.settingPreview.checked;
    cfg.autoStopSeconds = parseInt(els.settingAutoStop.value) || 0;
    cfg.bpmCalculationWindow = parseInt(els.settingBpmWindow.value) || 8;
    cfg.maxRecords = parseInt(els.settingMaxRecords.value) || 0;
    cfg.autoSave = els.settingAutoSave.checked;
    
    localStorage.setItem('pulse_settings', JSON.stringify(cfg));
    togglePreview();
    
    algo.detectedBeats = [];
    algo.bpm = 0;
}

function togglePreview() {
    els.preview.classList.toggle('hidden', !cfg.showPreview);
}

// ============================================================================
// Canvas Resize
// ============================================================================
function resize() {
    els.canvas.width = els.container.clientWidth;
    els.canvas.height = els.container.clientHeight;
}

window.addEventListener('resize', resize);
resize();

// ============================================================================
// Mode Management
// ============================================================================
async function setMode(newMode) {
    const prevMode = state.mode;
    
    // AUTO-SAVE CHECK FIRST - before any mode changes
    if ((prevMode === 'camera' || prevMode === 'simulate') && newMode === 'idle') {
        if (cfg.autoSave && state.history.length > 60) {
            await saveRec();
        }
    }
    
    // Now transition mode
    if (prevMode === 'camera' || prevMode === 'simulate') {
        state.mode = 'transition';
    }
    
    if (prevMode === 'camera' && newMode !== 'camera') {
        stopCamera();
        releaseWakeLock();
    }
    
    if (prevMode === 'review' && newMode !== 'review') {
        reviewData = null;
    }

    state.mode = newMode;
    state.history = [];
    state.totalTime = 0;
    state.framesSinceStart = 0;
    state.signalMean = 0;
    state.recentValues = [];
    state.currentGain = 1.0;
    algo.bpm = 0;
    algo.detectedBeats = [];
    algo.lastBeatTime = 0;
    
    els.saturationWarning.classList.add('hidden');
    els.torchWarning.classList.add('hidden');

    if (newMode === 'camera' || newMode === 'simulate') {
        session.id = Date.now();
        session.startTime = new Date().toISOString();
    } else {
        session.id = null;
        session.startTime = null;
    }

    els.instructionOverlay.classList.add('hidden');
    els.saveBtn.disabled = true;
    els.saveBtn.innerText = "Save";
    
    toggleClasses(els.reviewControls, null, ['flex']);
    els.reviewControls.classList.add('hidden');
    els.simControls.classList.add('hidden');
    
    toggleClasses(
        els.bpmDisplay,
        ['text-slate-500'],
        ['text-green-500', 'text-purple-500', 'text-amber-500']
    );
    
    els.bpmDisplay.innerText = "--";
    offCtx.clearRect(0, 0, 30, 30);

    const modeCfg = modeConfig[newMode];
    if (modeCfg) {
        els.modeBadge.innerText = modeCfg.badge.text;
        els.modeBadge.className = modeCfg.badge.class;
        
        if (modeCfg.camera) {
            toggleClasses(els.cameraBtn, modeCfg.camera.bg, modeCfg.camera.rm);
        }
        
        if (modeCfg.simulate) {
            toggleClasses(els.simulateBtn, modeCfg.simulate.bg, modeCfg.simulate.rm);
        }
    }

    if (newMode === 'idle') {
        els.instructionOverlay.classList.remove('hidden');
        releaseWakeLock();
        
    } else if (newMode === 'camera') {
        els.saveBtn.disabled = false;
        await startCamera();
        acquireWakeLock();
        
    } else if (newMode === 'simulate') {
        els.simControls.classList.remove('hidden');
        els.saveBtn.disabled = false;
        acquireWakeLock();
        
    } else if (newMode === 'review') {
        toggleClasses(els.reviewControls, ['flex'], ['hidden']);
        releaseWakeLock();
    }
}

// ============================================================================
// Export Functions
// ============================================================================
function exportAllData() {
    const raw = localStorage.getItem('hr_records');
    if (!raw) return alert("No data");
    
    const blob = new Blob([raw], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    a.href = url;
    a.download = `heart_rate_data_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
}

function exportGraphImage() {
    draw(state.mode === 'review' ? reviewData : state.history);
    
    ctx.save();
    ctx.fillStyle = "#0f172a";
    ctx.fillRect(0, 0, 140, 60);
    
    ctx.fillStyle = '#f59e0b';
    ctx.font = 'bold 24px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(`${els.bpmDisplay.innerText} BPM`, 10, 30);
    
    ctx.fillStyle = '#94a3b8';
    ctx.font = '10px sans-serif';
    ctx.fillText(new Date().toLocaleDateString(), 10, 45);
    ctx.restore();

    const link = document.createElement('a');
    link.download = `ecg_${Date.now()}.png`;
    link.href = els.canvas.toDataURL('image/png');
    link.click();
    
    requestAnimationFrame(() => draw(state.mode === 'review' ? reviewData : state.history));
}

// ============================================================================
// Camera Management
// ============================================================================
async function startCamera() {
    try {
        const constraints = {
            audio: false,
            video: {
                facingMode: 'environment',
                width: { ideal: 320 },
                height: { ideal: 240 },
                frameRate: { ideal: 60, min: 30 }
            }
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;
        
        await new Promise(r => els.video.onloadedmetadata = r);
        
        const track = stream.getVideoTracks()[0];
        await applyOptimizedConstraints(track);
        await els.video.play();
        
        updateCameraStats(track);
        
    } catch (err) {
        console.error("Camera Error:", err);
        alert("Camera unavailable or permission denied.");
        setMode('idle');
    }
}

async function applyOptimizedConstraints(track) {
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    const advanced = [];
    const mainConstraints = {};

    if (caps.torch) {
        advanced.push({ torch: true });
    }
    
    if (caps.focusMode && caps.focusMode.includes('continuous')) {
        mainConstraints.focusMode = 'continuous';
    }
    
    if (caps.whiteBalanceMode && caps.whiteBalanceMode.includes('single-shot')) {
        mainConstraints.whiteBalanceMode = 'single-shot';
    }
    
    if (caps.exposureCompensation) {
        const minExp = caps.exposureCompensation.min || -2;
        const maxExp = caps.exposureCompensation.max || 2;
        mainConstraints.exposureCompensation = Math.max(minExp, Math.min(maxExp, -1.0));
    }
    
    if (caps.iso && caps.iso.min) {
        mainConstraints.iso = caps.iso.min;
    }
    
    if (caps.frameRate && caps.frameRate.max >= 55) {
        mainConstraints.frameRate = { ideal: 60 };
    }

    try {
        await track.applyConstraints({ advanced, ...mainConstraints });
        els.torchWarning.classList.add('hidden');
        
    } catch (e) {
        console.warn('Could not apply advanced constraints:', e);
        
        if (caps.torch) {
            try {
                await track.applyConstraints({ advanced: [{ torch: true }] });
                els.torchWarning.classList.add('hidden');
            } catch(err) {
                console.error('Torch unavailable:', err);
                els.torchWarning.classList.remove('hidden');
            }
        } else {
            els.torchWarning.classList.remove('hidden');
        }
    }
}

function updateCameraStats(track) {
    const s = track.getSettings();
    
    els.statRes.innerText = `${s.width}x${s.height}`;
    els.statFps.innerText = s.frameRate ? s.frameRate.toFixed(1) : '--';
    els.statExp.innerText = s.exposureCompensation ? 
        s.exposureCompensation : (s.exposureMode || '--');
    els.statIso.innerText = s.iso || '--';
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => {
            try {
                t.applyConstraints({ advanced: [{ torch: false }] });
            } catch(e) {
                console.warn('Failed to turn off torch', e);
            }
            t.stop();
        });
        stream = null;
    }
    
    if (els.video) {
        els.video.pause();
        els.video.srcObject = null;
    }
}

// ============================================================================
// Signal Processing
// ============================================================================
function normalizeSignal(val) {
    state.recentValues.push(val);
    
    if (state.recentValues.length > 120) {
        state.recentValues.shift();
    }
    
    let min = -0.01;
    let max = 0.01;
    
    for (let v of state.recentValues) {
        if (v < min) min = v;
        if (v > max) max = v;
    }
    
    const targetGain = 0.7 / ((max - min) || 0.1);
    state.currentGain = (state.currentGain * 0.95) + (targetGain * 0.05);
    
    let norm = val * state.currentGain;
    els.debugGain.innerText = state.currentGain.toFixed(1);
    
    return Math.max(-0.6, Math.min(0.6, norm));
}

function processFrame() {
    offCtx.drawImage(els.video, 0, 0, 30, 30);
    const data = offCtx.getImageData(0, 0, 30, 30).data;
    
    let sum = 0;
    let count = 0;
    
    for (let i = 0; i < data.length; i += 16) {
        sum += data[i + 1];
        count++;
    }
    
    const avg = sum / count;
    
    els.saturationWarning.classList.toggle('hidden', avg <= 250);
    
    if (state.framesSinceStart < 30) {
        state.signalMean = avg;
        state.framesSinceStart++;
        return 0;
    }
    
    state.signalMean = (state.signalMean * 0.95) + (avg * 0.05);
    
    return normalizeSignal(state.signalMean - avg);
}

function generateSimulation(dt) {
    const dur = 60 / state.simBpm;
    state.simPhase += dt;
    
    if (state.simPhase > dur) {
        state.simPhase -= dur;
    }
    
    const t = state.simPhase / dur;
    
    const gaussian = (a, c, w) => {
        return a * Math.exp(-Math.pow(t - c, 2) / (2 * w * w));
    };
    
    let s = gaussian(1.0, 0.2, 0.08) + 
            gaussian(0.3, 0.5, 0.12) + 
            Math.sin(state.totalTime) * 0.1;
    
    return normalizeSignal(s * 0.05);
}

function processAlgo(val, time) {
    algo.runningMax *= algo.decayRate;
    algo.threshold = Math.max(algo.runningMax * 0.5, 0.05);
    
    if (val > algo.runningMax) {
        algo.runningMax = val;
    }
    
    let isBeat = false;
    
    if (val > algo.threshold && 
        (time - algo.lastBeatTime) > algo.refractoryPeriod) {
        
        if (algo.runningMax > 0.15) {
            algo.lastBeatTime = time;
            isBeat = true;
            
            toggleClasses(els.beatIndicator, ['bg-red-500', 'scale-150']);
            setTimeout(() => {
                toggleClasses(els.beatIndicator, null, ['bg-red-500', 'scale-150']);
            }, 100);
            
            algo.detectedBeats.push(time);
            
            const limit = cfg.bpmCalculationWindow;
            while(algo.detectedBeats.length > limit) {
                algo.detectedBeats.shift();
            }

            if (algo.detectedBeats.length >= 2) {
                let sum = 0;
                
                for (let i = 1; i < algo.detectedBeats.length; i++) {
                    sum += (algo.detectedBeats[i] - algo.detectedBeats[i-1]);
                }
                
                let bpm = 60000 / (sum / (algo.detectedBeats.length - 1));
                algo.bpm = algo.bpm === 0 ? bpm : (algo.bpm * 0.7 + bpm * 0.3);
                algo.refractoryPeriod = Math.max(250, Math.min((60000 / algo.bpm) * 0.6, 1000));
                
                els.bpmDisplay.innerText = Math.round(algo.bpm);
                
                const colorClass = state.mode === 'camera' ? 
                    "text-green-500" : "text-purple-500";
                    
                els.bpmDisplay.className = 
                    "text-4xl font-mono font-bold tracking-tighter " + colorClass;
            }
        }
    }
    
    return { isBeat, threshold: algo.threshold };
}

function updateHistory(time, val, thresh, beat, bpm) {
    state.history.push({
        time,
        val,
        threshold: thresh,
        beat,
        bpm
    });
    
    if (state.history.length > 10800) {
        state.history.shift();
    }
}

// ============================================================================
// Storage Management
// ============================================================================
async function saveRec() {
    const historySnapshot = [...state.history];
    const sessionIdSnapshot = session.id;
    const startTimeSnapshot = session.startTime;
    const bpmSnapshot = algo.bpm;
    const totalTimeSnapshot = state.totalTime;

    if (historySnapshot.length < 60) {
        if (!cfg.autoSave) {
            alert("Too short to save");
        }
        return;
    }

    if (navigator.storage && navigator.storage.estimate) {
        try {
            const estimate = await navigator.storage.estimate();
            
            if (estimate.quota > 0) {
                const usageRatio = estimate.usage / estimate.quota;
                
                if (usageRatio > 0.95) {
                    return alert("Storage full. Delete old recordings to continue.");
                }
                
                if (usageRatio > 0.85) {
                    alert(`Storage almost full (${(estimate.usage/1024/1024).toFixed(1)}MB used). Consider deleting old recordings.`);
                }
            }
        } catch(e) {
            console.warn("Quota check failed", e);
        }
    }
    
    try {
        let recs = JSON.parse(localStorage.getItem('hr_records') || '[]');
        
        if (cfg.maxRecords > 0 && recs.length >= cfg.maxRecords) {
            recs.splice(cfg.maxRecords - 1);
        }

        const existingIndex = recs.findIndex(r => r.id === sessionIdSnapshot);
        
        // Store samples with timestamps (v4 format)
        const samples = historySnapshot.map(h => ({
            t: h.time,
            v: h.val
        }));

        const recordData = {
            id: sessionIdSnapshot || Date.now(),
            v: 4,  // New version with timestamps
            timestamp: startTimeSnapshot || new Date().toISOString(),
            avgBpm: Math.round(bpmSnapshot) || '--',
            duration: totalTimeSnapshot,
            samples
        };

        if (existingIndex >= 0) {
            recs[existingIndex] = recordData;
        } else {
            recs.unshift(recordData);
        }

        localStorage.setItem('hr_records', JSON.stringify(recs));
        renderList();
        
        els.saveBtn.innerText = "Saved";
        setTimeout(() => els.saveBtn.innerText = "Save", 1500);
        
    } catch(e) {
        console.error(e);
        
        if (e.name === 'QuotaExceededError') {
            alert("Storage full. Please delete old recordings.");
        } else if (!cfg.autoSave) {
            alert("Save failed");
        }
    }
}

function renderList() {
    let recs = JSON.parse(localStorage.getItem('hr_records') || '[]');
    
    const validRecs = recs.filter(r => {
        // Only accept v4 format (with timestamps)
        if (r.v === 4 && Array.isArray(r.samples)) {
            return true;
        }
        console.log('Ignoring old format recording:', r.id, r.timestamp, 'version:', r.v);
        return false;
    });
    
    if (validRecs.length !== recs.length) {
        recs = validRecs;
        localStorage.setItem('hr_records', JSON.stringify(recs));
    }

    const jsonStr = JSON.stringify(recs);
    const sizeMB = (new Blob([jsonStr]).size / 1024 / 1024).toFixed(2);
    const sizeNum = parseFloat(sizeMB);
    
    els.storageInfo.innerText = `${sizeMB}MB / ~5MB`;
    
    if (sizeNum > 4.5) {
        els.storageInfo.className = "text-[9px] font-mono text-rose-500 font-bold";
    } else if (sizeNum > 3.5) {
        els.storageInfo.className = "text-[9px] font-mono text-amber-500 font-bold";
    } else {
        els.storageInfo.className = "text-[9px] font-mono text-slate-600";
    }
    
    els.savedList.innerHTML = '';
    
    if (!recs.length) {
        return els.savedList.appendChild(els.emptyState);
    }
    
    recs.forEach(r => {
        const d = new Date(r.timestamp);
        const div = document.createElement('div');
        
        div.className = "bg-slate-800/80 p-3 rounded-lg border border-slate-700 hover:border-sky-500 cursor-pointer flex justify-between items-center transition-all active:scale-[0.98]";
        
        div.innerHTML = `
            <div>
                <div class="font-bold text-sky-400 text-xs">
                    ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                </div>
                <div class="text-[10px] text-slate-500">
                    ${d.toLocaleDateString()} • ${r.duration.toFixed(1)}s
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <div class="text-[9px] text-slate-500 uppercase">Avg BPM</div>
                    <div class="font-bold text-slate-200 text-sm">${r.avgBpm}</div>
                </div>
                <button class="del p-2 text-slate-500 hover:text-rose-400" data-id="${r.id}">✕</button>
            </div>
        `;
        
        div.onclick = (e) => {
            if (e.target.classList.contains('del')) {
                localStorage.setItem(
                    'hr_records',
                    JSON.stringify(recs.filter(x => x.id !== r.id))
                );
                renderList();
            } else {
                setMode('review');
                
                const values = r.samples.map(s => s.v);
                const timestamps = r.samples.map(s => s.t);
                
                const thresholds = calculateThreshold(values);
                const beatIndices = detectBeats(values, thresholds);
                const calculatedBpm = calculateBPM(
                    beatIndices,
                    values,
                    timestamps,
                    cfg.bpmCalculationWindow
                );

                reviewData = r.samples.map((sample, i) => ({
                    time: sample.t,
                    val: sample.v,
                    threshold: thresholds[i].threshold,
                    beat: beatIndices.includes(i),
                    bpm: calculatedBpm || r.avgBpm
                }));
                
                reviewData.duration = r.duration;
                
                els.historySlider.min = 0;
                els.historySlider.max = r.samples.length;
                els.historySlider.value = r.samples.length;
                
                state.reviewOffset = r.samples.length;
                
                els.bpmDisplay.innerText = calculatedBpm || r.avgBpm;
                els.bpmDisplay.className = 
                    "text-4xl font-mono font-bold text-amber-500 tracking-tighter";
                
                draw(reviewData);
            }
        };
        
        els.savedList.appendChild(div);
    });
}

// ============================================================================
// Animation Loop
// ============================================================================
async function loop(t) {
    if (!state.lastTime) state.lastTime = t;
    
    const dt = (t - state.lastTime) / 1000;
    state.lastTime = t;

    if (state.mode === 'camera' || state.mode === 'simulate') {
        state.totalTime += dt;
        
        if (cfg.autoStopSeconds > 0 && state.totalTime >= cfg.autoStopSeconds) {
            await setMode('idle');
        } else {
            let s = state.mode === 'camera' ? 
                processFrame() : generateSimulation(dt);
                
            const res = processAlgo(s, t);
            updateHistory(state.totalTime, s, res.threshold, res.isBeat, Math.round(algo.bpm));
        }
    }
    
    draw(state.mode === 'review' ? reviewData : state.history);
    
    animationFrameId = requestAnimationFrame(loop);
}

// ============================================================================
// Drawing Function
// ============================================================================
function draw(dataSource) {
    const data = dataSource || [];
    
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, els.canvas.width, els.canvas.height);
    
    if (!data.length) return;
    
    let end = state.mode === 'review' ? state.reviewOffset : data.length;
    let start = Math.max(0, end - els.canvas.width);
    
    if (state.mode === 'review') {
        // Use actual timestamps for review display
        if (end > 0 && data[end - 1]) {
            const currentTime = data[end - 1].time;
            const totalTime = data[data.length - 1].time;
            const timeFromEnd = totalTime - currentTime;
            els.reviewTimeDisplay.innerText = `-${timeFromEnd.toFixed(1)}s`;
            
            // Recalculate BPM based on visible window
            const values = data.slice(0, end).map(d => d.val);
            const timestamps = data.slice(0, end).map(d => d.time);
            const thresholds = calculateThreshold(values);
            const beatIndices = detectBeats(values, thresholds);
            const displayBpm = calculateBPM(
                beatIndices,
                values,
                timestamps,
                cfg.bpmCalculationWindow
            );
            
            if (displayBpm) {
                els.bpmDisplay.innerText = displayBpm;
            }
        }
    }

    const viewData = data.slice(start, end);
    if (!viewData.length) return;

    const cy = els.canvas.height / 2;
    const sy = els.canvas.height / 2.2;
    const my = v => cy - v * sy;

    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.font = "9px monospace";

    // Draw grid lines using actual timestamps
    for (let i = 0; i < viewData.length; i++) {
        const currentTime = viewData[i].time;
        const prevTime = i > 0 ? viewData[i - 1].time : currentTime;
        
        // 200ms grid (5Hz)
        if (Math.floor(currentTime * 5) !== Math.floor(prevTime * 5)) {
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.moveTo(i, 0);
            ctx.lineTo(i, els.canvas.height);
            ctx.stroke();
        }

        // 1 second grid
        if (Math.floor(currentTime) !== Math.floor(prevTime)) {
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
            ctx.moveTo(i, 0);
            ctx.lineTo(i, els.canvas.height);
            ctx.stroke();
            
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillText(Math.floor(currentTime) + 's', i, els.canvas.height - 2);
        }
    }

    // Draw threshold line
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,200,0,0.3)';
    ctx.setLineDash([4, 4]);
    
    viewData.forEach((d, i) => {
        if (i === 0) {
            ctx.moveTo(i, my(d.threshold));
        } else {
            ctx.lineTo(i, my(d.threshold));
        }
    });
    
    ctx.stroke();
    ctx.setLineDash([]);

    // Draw signal
    const color = state.mode === 'simulate' ? '#a855f7' :
                  (state.mode === 'review' ? '#f59e0b' : '#ef4444');
    
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    
    viewData.forEach((d, i) => {
        if (i === 0) {
            ctx.moveTo(i, my(d.val));
        } else {
            ctx.lineTo(i, my(d.val));
        }
    });
    
    ctx.stroke();

    // Fill area under signal
    ctx.lineTo(viewData.length - 1, els.canvas.height);
    ctx.lineTo(0, els.canvas.height);
    ctx.fillStyle = color + "20";
    ctx.fill();

    // Draw beat markers
    ctx.fillStyle = "#fff";
    
    viewData.forEach((d, i) => {
        if (d.beat) {
            ctx.beginPath();
            ctx.arc(i, my(d.val), 3, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

// ============================================================================
// Modal Functions
// ============================================================================
function openSettings() {
    els.settingsModal.classList.remove('hidden');
    
    setTimeout(() => {
        toggleClasses(
            els.settingsContent,
            ['scale-100', 'opacity-100'],
            ['scale-95', 'opacity-0']
        );
    }, 10);
}

function closeSettings() {
    saveSettings();
    
    toggleClasses(
        els.settingsContent,
        ['scale-95', 'opacity-0'],
        ['scale-100', 'opacity-100']
    );
    
    setTimeout(() => els.settingsModal.classList.add('hidden'), 200);
}

// ============================================================================
// Event Listeners
// ============================================================================
els.historySlider.addEventListener('input', e => {
    state.reviewOffset = parseInt(e.target.value);
});

els.bpmSlider.addEventListener('input', e => {
    state.simBpm = parseInt(e.target.value);
    els.targetBpmValue.innerText = state.simBpm;
});

els.cameraBtn.onclick = () => {
    setMode(state.mode === 'camera' ? 'idle' : 'camera');
};

els.simulateBtn.onclick = () => {
    setMode(state.mode === 'simulate' ? 'idle' : 'simulate');
};

els.saveBtn.onclick = saveRec;
els.backToLiveBtn.onclick = () => setMode('idle');
els.exportJsonBtn.onclick = exportAllData;
els.exportImgBtn.onclick = exportGraphImage;
els.settingsBtn.onclick = openSettings;
els.closeSettingsBtn.onclick = closeSettings;

els.settingsModal.onclick = (e) => {
    if (e.target === els.settingsModal) {
        closeSettings();
    }
};

els.deleteOldestBtn.onclick = () => {
    try {
        let recs = JSON.parse(localStorage.getItem('hr_records') || '[]');
        
        if (recs.length === 0) {
            return alert("No records to delete");
        }
        
        recs.splice(recs.length - 10, 10);
        localStorage.setItem('hr_records', JSON.stringify(recs));
        renderList();
        alert("Deleted oldest records");
        
    } catch(e) {
        console.error(e);
    }
};

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        cancelAnimationFrame(animationFrameId);
        
        if (state.mode === 'camera') {
            stopCamera();
            releaseWakeLock();
            
            state.mode = 'idle';
            els.modeBadge.innerText = "PAUSED";
            els.modeBadge.className = 
                "text-[10px] px-1.5 py-0.5 rounded bg-amber-900/50 border border-amber-700 text-amber-300 font-bold uppercase";
            
            els.saveBtn.disabled = false;
            els.saveBtn.innerText = "Save Partial";
            
            toggleClasses(
                els.cameraBtn,
                ['bg-sky-600', 'hover:bg-sky-500'],
                ['bg-rose-600', 'hover:bg-rose-500']
            );
        }
    } else {
        loop(performance.now());
    }
});

window.onpagehide = stopCamera;

// ============================================================================
// Initialization
// ============================================================================
loadSettings();
renderList();
loop(performance.now());

</script>
</body>
</html>
