<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pulse Monitor v2</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pulse">

    <link rel="icon" id="dynamic-favicon">
    <link rel="apple-touch-icon" id="dynamic-apple-icon">
    <link rel="manifest" id="dynamic-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow: hidden; 
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.3); }
        .scroller::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        .monitor-grid {
            background-image: linear-gradient(rgba(255, 65, 65, 0.1) 1px, transparent 1px);
            background-size: 100% 20px;
        }
        .control-panel {
            backdrop-filter: blur(12px);
            background-color: rgba(15, 23, 42, 0.92);
            padding-bottom: env(safe-area-inset-bottom);
        }
        input[type=range].scrubber {
            -webkit-appearance: none; background: transparent;
        }
        input[type=range].scrubber::-webkit-slider-runnable-track {
            height: 6px; background: #334155; border-radius: 3px;
        }
        input[type=range].scrubber::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px;
            border-radius: 50%; background: #38bdf8; margin-top: -6px;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #38bdf8; }
        .toggle-checkbox:checked + .toggle-label { background-color: #38bdf8; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s; }
        .modal-exit { opacity: 0; transform: scale(0.95); transition: all 0.2s; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header / Stats -->
    <div class="flex-none pt-safe-top px-4 pb-2 flex justify-between items-center bg-slate-900/80 border-b border-slate-700/50 z-10 backdrop-blur-md">
        <div class="flex flex-col pt-2">
            <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Heart Rate</span>
            <div class="flex items-baseline gap-2">
                <span id="bpmDisplay" class="text-4xl font-mono font-bold text-slate-500 tracking-tighter">--</span>
                <span id="modeBadge" class="text-[10px] px-1.5 py-0.5 rounded border border-slate-700 text-slate-400 font-bold uppercase">Idle</span>
            </div>
        </div>
        
        <div class="text-right flex flex-col items-end pt-2 gap-1">
             <div class="flex items-center gap-2">
                 <!-- Tiny Preview Canvas -->
                 <canvas id="previewCanvas" width="30" height="30" class="w-8 h-8 rounded border border-slate-600 bg-black hidden pixelated"></canvas>
                 
                 <div id="beatIndicator" class="w-3 h-3 rounded-full bg-slate-800 transition-colors duration-75 inline-block"></div>
                 
                 <!-- Settings Button -->
                 <button id="settingsBtn" class="p-1 text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                 </button>
             </div>
             
             <div class="flex items-center gap-2 mt-1">
                 <div id="wakeLockIndicator" class="hidden text-[9px] text-amber-500 font-bold flex items-center gap-1 opacity-80">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span>AWAKE</span>
                 </div>
                 <span id="storageInfo" class="text-[9px] font-mono text-slate-600">0MB</span>
             </div>
        </div>
    </div>

    <!-- Main Chart Area -->
    <div class="flex-grow relative monitor-grid bg-black overflow-hidden group" id="canvasContainer">
        <canvas id="ppgCanvas"></canvas>
        <video id="videoElement" playsinline style="display:none;"></video>
        
        <!-- Instructions Overlay -->
        <div id="instructionOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none bg-black/60 z-10 transition-opacity duration-300">
            <div class="text-center p-6 max-w-sm">
                <div class="text-slate-200 font-bold text-lg mb-2">Ready to Measure</div>
                <p class="text-slate-400 text-sm">Select a mode below.</p>
                <div class="mt-4 text-xs text-slate-500 border border-slate-700 rounded p-2 bg-slate-900/50">
                    <span class="font-bold text-sky-400">Camera Mode:</span> Cover the back camera & flash gently with your fingertip.
                </div>
            </div>
        </div>

        <div class="absolute bottom-2 right-2 text-[9px] font-mono text-slate-600 pointer-events-none hidden sm:block">
            Gain: <span id="debugGain">1.0</span>x
        </div>

        <!-- Review Controls -->
        <div id="reviewControls" class="absolute bottom-4 left-4 right-4 bg-slate-800/95 p-4 rounded-xl border border-slate-600/50 hidden flex-col gap-3 z-20 shadow-2xl backdrop-blur-xl">
            <div class="flex justify-between text-xs text-slate-300 font-bold">
                <span>Timeline</span>
                <span id="reviewTimeDisplay" class="font-mono text-sky-400">Live</span>
            </div>
            <input type="range" id="historySlider" min="0" max="100" value="100" class="w-full scrubber accent-sky-500">
            <div class="grid grid-cols-2 gap-3 mt-1">
                <button id="exportImgBtn" class="py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg text-xs transition-colors border border-slate-600">
                    Save Graph Img
                </button>
                <button id="backToLiveBtn" class="py-2.5 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-lg text-xs transition-colors shadow-lg shadow-sky-900/20">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Controls & List -->
    <div class="flex-none flex flex-col h-[35vh] min-h-[240px] control-panel border-t border-slate-700/50 z-20">
        <!-- Action Buttons -->
        <div class="p-3 border-b border-slate-700/50 flex flex-col gap-3">
            <div class="grid grid-cols-3 gap-2">
                <button id="cameraToggleBtn" class="h-11 bg-sky-600 hover:bg-sky-500 active:bg-sky-700 text-white font-bold rounded-lg shadow-lg shadow-sky-900/20 flex flex-col items-center justify-center text-xs transition-all">
                    Camera
                </button>
                <button id="simulateBtn" class="h-11 bg-purple-600 hover:bg-purple-500 active:bg-purple-700 text-white font-bold rounded-lg shadow-lg shadow-purple-900/20 flex flex-col items-center justify-center text-xs transition-all">
                    Simulate
                </button>
                <button id="saveBtn" class="h-11 bg-slate-700 hover:bg-slate-600 active:bg-slate-800 text-white font-bold rounded-lg border border-slate-600 flex flex-col items-center justify-center text-xs transition-all disabled:opacity-40" disabled>
                    Save
                </button>
            </div>
            <!-- Sim Slider -->
            <div id="simControls" class="hidden bg-slate-800/80 p-2.5 rounded-lg border border-slate-700 animate-fade-in">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-purple-400 uppercase tracking-wider">Sim Rate</label>
                    <span id="targetBpmValue" class="text-[10px] font-mono bg-purple-900/50 text-purple-200 px-1.5 py-0.5 rounded">75</span>
                </div>
                <input type="range" id="bpmSlider" min="40" max="220" value="75" class="w-full h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
            </div>
        </div>

        <!-- History Header -->
        <div class="px-4 py-2 bg-slate-800/50 text-[10px] font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center backdrop-blur-sm">
            <span>Recent History</span>
            <button id="exportJsonBtn" class="text-sky-400 hover:text-white p-1" title="Download JSON">
                Export All ⬇
            </button>
        </div>

        <!-- List -->
        <div id="savedListContainer" class="flex-grow overflow-y-auto scroller p-2 space-y-1.5 pb-safe-bottom">
            <div class="text-center text-slate-600 text-xs py-8 italic" id="emptyState">No saved records</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-800 w-11/12 max-w-sm rounded-xl border border-slate-600 shadow-2xl p-5 transform transition-all duration-200 scale-95 opacity-0" id="settingsContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-slate-100 font-bold text-lg">Settings</h3>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- Toggle Preview -->
                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">Camera Preview</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="settingPreview" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="settingPreview" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>

                <!-- Auto Stop -->
                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">
                        Auto-Stop (seconds)
                        <span class="block text-[10px] text-slate-500">0 = Manual stop</span>
                    </label>
                    <input type="number" id="settingAutoStop" min="0" max="300" class="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center text-sm text-white focus:border-sky-500 outline-none">
                </div>

                <!-- Auto Save -->
                <div class="flex items-center justify-between">
                    <label class="text-sm text-slate-300">Auto-Save on Stop</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="settingAutoSave" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="settingAutoSave" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <span class="text-[10px] text-slate-600 font-mono">Pulse Monitor v2.1</span>
            </div>
        </div>
    </div>

<script>
/**
 * PWA SETUP
 */
(function setupPWA() {
    const iconSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='#0f172a'/><path d='M256 448l-30-30C118 322 48 250 48 162C48 90 106 32 178 32c40 0 78 22 96 56c18-34 56-56 96-56c72 0 130 58 130 130c0 88-70 160-178 256l-30 30z' fill='#ef4444'/></svg>`;
    const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);
    document.getElementById('dynamic-favicon').href = iconUrl;
    document.getElementById('dynamic-apple-icon').href = iconUrl;
    const manifest = {
        "name": "Pulse Monitor",
        "short_name": "Pulse",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0f172a",
        "theme_color": "#0f172a",
        "orientation": "portrait",
        "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }]
    };
    document.getElementById('dynamic-manifest').href = "data:application/manifest+json;base64," + btoa(JSON.stringify(manifest));
})();

/**
 * WAKE LOCK
 */
let wakeLock = null;
const wakeLockIndicator = document.getElementById('wakeLockIndicator');

async function acquireWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLockIndicator.classList.remove('hidden');
            wakeLock.addEventListener('release', () => {
                wakeLockIndicator.classList.add('hidden');
            });
        } catch (err) { console.warn('Wake Lock error', err); }
    }
}

async function releaseWakeLock() {
    if (wakeLock !== null) {
        try { await wakeLock.release(); wakeLock = null; } catch(e) {}
        wakeLockIndicator.classList.add('hidden');
    }
}

/**
 * APP SETTINGS & STATE
 */
const CONFIG = {
    maxHistorySeconds: 180, 
    sampleRate: 60,
};

const appSettings = {
    showPreview: false,
    autoStopSeconds: 0,
    autoSave: false
};

const state = {
    mode: 'idle',
    lastTime: 0,
    totalTime: 0,
    history: [], 
    reviewOffset: 0,
    timeSinceLastMinorGrid: 0,
    signalMean: 0,
    framesSinceStart: 0,
    recentValues: [], 
    currentGain: 1.0,
    simPhase: 0,
    simBpm: 75
};

const currentSession = {
    id: null,
    startTime: null
};

const algoState = {
    lastBeatTime: 0,
    refractoryPeriod: 250, 
    runningMax: 0.1, 
    threshold: 0.05,
    decayRate: 0.99,        
    detectedBeats: [],      
    bpm: 0
};

// Processing Setup
const video = document.getElementById('videoElement');
const offscreenCanvas = document.createElement('canvas');
const offCtx = offscreenCanvas.getContext('2d', { willReadFrequently: true });
let stream = null;
let animationFrameId = null; 
offscreenCanvas.width = 30;
offscreenCanvas.height = 30;

// DOM
const canvas = document.getElementById('ppgCanvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('canvasContainer');
const measuredBpmDisplay = document.getElementById('bpmDisplay');
const beatIndicator = document.getElementById('beatIndicator');
const modeBadge = document.getElementById('modeBadge');
const instructionOverlay = document.getElementById('instructionOverlay');
const cameraToggleBtn = document.getElementById('cameraToggleBtn');
const simulateBtn = document.getElementById('simulateBtn');
const simControls = document.getElementById('simControls');
const bpmSlider = document.getElementById('bpmSlider');
const targetBpmDisplay = document.getElementById('targetBpmValue');
const debugGain = document.getElementById('debugGain');
const saveBtn = document.getElementById('saveBtn');
const savedListContainer = document.getElementById('savedListContainer');
const reviewControls = document.getElementById('reviewControls');
const historySlider = document.getElementById('historySlider');
const backToLiveBtn = document.getElementById('backToLiveBtn');
const reviewTimeDisplay = document.getElementById('reviewTimeDisplay');
const emptyState = document.getElementById('emptyState');
const storageInfo = document.getElementById('storageInfo');
const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportImgBtn = document.getElementById('exportImgBtn');

// New Elements
const previewCanvas = document.getElementById('previewCanvas');
const previewCtx = previewCanvas.getContext('2d');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsContent = document.getElementById('settingsContent');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const settingPreview = document.getElementById('settingPreview');
const settingAutoStop = document.getElementById('settingAutoStop');
const settingAutoSave = document.getElementById('settingAutoSave');

// --- Initialization ---
function loadSettings() {
    const saved = localStorage.getItem('pulse_settings');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            Object.assign(appSettings, parsed);
        } catch(e) {}
    }
    // Update UI
    settingPreview.checked = appSettings.showPreview;
    settingAutoStop.value = appSettings.autoStopSeconds;
    settingAutoSave.checked = appSettings.autoSave;
    togglePreviewVisibility();
}

function saveSettings() {
    appSettings.showPreview = settingPreview.checked;
    appSettings.autoStopSeconds = parseInt(settingAutoStop.value) || 0;
    appSettings.autoSave = settingAutoSave.checked;
    localStorage.setItem('pulse_settings', JSON.stringify(appSettings));
    togglePreviewVisibility();
}

function togglePreviewVisibility() {
    if (appSettings.showPreview) previewCanvas.classList.remove('hidden');
    else previewCanvas.classList.add('hidden');
}

// Resize
function resize() {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
}
window.addEventListener('resize', resize);
resize();

// Mode Handling
async function setMode(newMode) {
    if (state.mode === 'camera' && newMode !== 'camera') {
        stopCamera();
        releaseWakeLock();
    }
    
    // Auto-save check when stopping a recording session
    if ((state.mode === 'camera' || state.mode === 'simulate') && newMode === 'idle') {
        if (appSettings.autoSave && state.history.length > 60) {
            saveRec();
        }
    }

    // Clear old state
    state.mode = newMode;
    state.history = []; 
    state.totalTime = 0;
    state.framesSinceStart = 0;
    state.signalMean = 0;
    state.recentValues = [];
    state.currentGain = 1.0;
    algoState.bpm = 0;
    algoState.detectedBeats = [];
    algoState.lastBeatTime = 0;

    // Reset Session
    if (newMode === 'camera' || newMode === 'simulate') {
        currentSession.id = Date.now();
        currentSession.startTime = new Date().toISOString();
    } else {
        currentSession.id = null;
        currentSession.startTime = null;
    }

    // UI Reset
    instructionOverlay.classList.add('hidden');
    saveBtn.disabled = true;
    saveBtn.innerText = "Save";
    reviewControls.classList.add('hidden');
    reviewControls.classList.remove('flex');
    simControls.classList.add('hidden');
    measuredBpmDisplay.classList.remove('text-green-500', 'text-purple-500', 'text-amber-500');
    measuredBpmDisplay.classList.add('text-slate-500');
    measuredBpmDisplay.innerText = "--";
    previewCtx.clearRect(0,0,30,30); // Clear preview

    if (newMode === 'idle') {
        instructionOverlay.classList.remove('hidden');
        modeBadge.innerText = "IDLE";
        modeBadge.className = "text-[10px] px-1.5 py-0.5 rounded border border-slate-700 text-slate-400 font-bold uppercase";
        cameraToggleBtn.classList.remove('bg-rose-600', 'hover:bg-rose-500');
        cameraToggleBtn.classList.add('bg-sky-600', 'hover:bg-sky-500');
        simulateBtn.classList.remove('bg-rose-600', 'hover:bg-rose-500');
        simulateBtn.classList.add('bg-purple-600', 'hover:bg-purple-500');
        releaseWakeLock();
    } else if (newMode === 'camera') {
        modeBadge.innerText = "CAMERA";
        modeBadge.className = "text-[10px] px-1.5 py-0.5 rounded bg-sky-900/50 border border-sky-700 text-sky-300 font-bold uppercase";
        cameraToggleBtn.classList.add('bg-rose-600', 'hover:bg-rose-500'); 
        cameraToggleBtn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
        saveBtn.disabled = false;
        await startCamera();
        acquireWakeLock();
    } else if (newMode === 'simulate') {
        modeBadge.innerText = "SIM";
        modeBadge.className = "text-[10px] px-1.5 py-0.5 rounded bg-purple-900/50 border border-purple-700 text-purple-300 font-bold uppercase";
        simulateBtn.classList.add('bg-rose-600', 'hover:bg-rose-500'); 
        simulateBtn.classList.remove('bg-purple-600', 'hover:bg-purple-500');
        simControls.classList.remove('hidden');
        saveBtn.disabled = false;
        acquireWakeLock();
    } else if (newMode === 'review') {
        modeBadge.innerText = "REVIEW";
        modeBadge.className = "text-[10px] px-1.5 py-0.5 rounded bg-amber-900/50 border border-amber-700 text-amber-300 font-bold uppercase";
        reviewControls.classList.remove('hidden');
        reviewControls.classList.add('flex');
        releaseWakeLock();
    }
}

// Export
function exportAllData() {
    const raw = localStorage.getItem('hr_records');
    if (!raw) return alert("No data");
    const blob = new Blob([raw], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `heart_rate_data_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportGraphImage() {
    draw(); 
    ctx.save();
    ctx.fillStyle = "#0f172a"; 
    ctx.fillRect(0, 0, 140, 60);
    ctx.fillStyle = '#f59e0b'; 
    ctx.font = 'bold 24px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(`${measuredBpmDisplay.innerText} BPM`, 10, 30);
    ctx.fillStyle = '#94a3b8'; 
    ctx.font = '10px sans-serif';
    ctx.fillText(new Date().toLocaleDateString(), 10, 45);
    ctx.restore();

    const link = document.createElement('a');
    link.download = `ecg_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    requestAnimationFrame(draw); 
}

// Camera
async function startCamera() {
    try {
        const constraints = {
            audio: false,
            video: {
                facingMode: 'environment',
                width: { ideal: 320 }, 
                height: { ideal: 240 },
                frameRate: { ideal: 30 }
            }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = () => { video.play(); r(); });
        
        const track = stream.getVideoTracks()[0];
        try {
            const cap = track.getCapabilities();
            if (cap.torch) await track.applyConstraints({ advanced: [{ torch: true }] });
        } catch (e) {}
    } catch (err) {
        alert("Camera unavailable.");
        setMode('idle');
    }
}

function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    if (video) { video.pause(); video.srcObject = null; }
}

// Signal Proc
function normalizeSignal(val) {
    state.recentValues.push(val);
    if (state.recentValues.length > 120) state.recentValues.shift();
    let min = -0.01, max = 0.01; 
    for (let v of state.recentValues) {
        if (v < min) min = v;
        if (v > max) max = v;
    }
    const targetGain = 0.7 / ((max - min) || 0.1); 
    state.currentGain = (state.currentGain * 0.95) + (targetGain * 0.05);
    let norm = val * state.currentGain;
    debugGain.innerText = state.currentGain.toFixed(1);
    return Math.max(-0.6, Math.min(0.6, norm));
}

function processFrame() {
    if (!video || video.paused) return 0;
    
    // Draw frame to offscreen for analysis
    offCtx.drawImage(video, 0, 0, 30, 30);
    
    // If preview enabled, copy small canvas to visible canvas
    if (appSettings.showPreview) {
        previewCtx.drawImage(offscreenCanvas, 0, 0, 30, 30);
    }

    const data = offCtx.getImageData(0, 0, 30, 30).data;
    let sum = 0;
    for (let i = 0; i < data.length; i += 4) sum += data[i + 1]; // Green channel usually better, but Red ok for torch
    // Note: Previous version used index +1 (Green) or Red. For blood with torch, Red is high, but modulation is visible in all.
    // Let's stick to the logic provided: Green is usually i+1, Red is i. The previous code did i+1.
    // Just ensuring we use standard RGBA. R=0, G=1, B=2.
    
    const avg = sum / 900;
    
    if (state.framesSinceStart < 30) {
        state.signalMean = avg;
        state.framesSinceStart++;
        return 0;
    }
    state.signalMean = (state.signalMean * 0.95) + (avg * 0.05);
    return normalizeSignal(state.signalMean - avg);
}

function generateSimulation(dt) {
    const dur = 60 / state.simBpm;
    state.simPhase += dt;
    if (state.simPhase > dur) state.simPhase -= dur;
    const t = state.simPhase / dur;
    const gaussian = (a, c, w) => a * Math.exp(-Math.pow(t - c, 2) / (2 * w * w));
    let s = gaussian(1.0, 0.2, 0.08) + gaussian(0.3, 0.5, 0.12) + Math.sin(state.totalTime)*0.1;
    return normalizeSignal(s * 0.05);
}

function processAlgo(val, time) {
    algoState.runningMax *= algoState.decayRate;
    algoState.threshold = Math.max(algoState.runningMax * 0.5, 0.05);
    if (val > algoState.runningMax) algoState.runningMax = val;
    let isBeat = false;
    if (val > algoState.threshold && (time - algoState.lastBeatTime) > algoState.refractoryPeriod) {
        if (algoState.runningMax > 0.15) {
            algoState.lastBeatTime = time;
            isBeat = true;
            beatIndicator.classList.add('bg-red-500', 'scale-150');
            setTimeout(() => beatIndicator.classList.remove('bg-red-500', 'scale-150'), 100);
            
            algoState.detectedBeats.push(time);
            if(algoState.detectedBeats.length > 8) algoState.detectedBeats.shift();
            if(algoState.detectedBeats.length >= 2) {
                let sum = 0;
                for(let i=1; i<algoState.detectedBeats.length; i++) sum += (algoState.detectedBeats[i]-algoState.detectedBeats[i-1]);
                let bpm = 60000 / (sum/(algoState.detectedBeats.length-1));
                algoState.bpm = algoState.bpm === 0 ? bpm : (algoState.bpm * 0.7 + bpm * 0.3);
                algoState.refractoryPeriod = Math.max(250, Math.min((60000/algoState.bpm)*0.6, 1000));
                
                measuredBpmDisplay.innerText = Math.round(algoState.bpm);
                measuredBpmDisplay.className = "text-4xl font-mono font-bold tracking-tighter " + (state.mode === 'camera' ? "text-green-500" : "text-purple-500");
            }
        }
    }
    return { isBeat, threshold: algoState.threshold };
}

function updateHistory(val, thresh, beat, bpm, dt) {
    state.timeSinceLastMinorGrid += dt;
    let gridType = null, gridLabel = null;
    if (state.timeSinceLastMinorGrid >= 0.2) {
        const steps = Math.floor(state.timeSinceLastMinorGrid / 0.2);
        state.timeSinceLastMinorGrid -= (steps * 0.2);
        if (Math.floor(state.totalTime) > Math.floor(state.totalTime - steps*0.2)) {
            gridType = 'major'; gridLabel = Math.floor(state.totalTime) + 's';
        } else gridType = 'minor';
    }
    state.history.push({ val, threshold: thresh, beat, grid: gridType, label: gridLabel, bpm });
    if (state.history.length > 10800) state.history.shift();
}

// Storage
function saveRec() {
    if(state.history.length < 60) {
        // Only alert if we are manually saving, if auto-saving silently fail
        if(!appSettings.autoSave || state.mode !== 'idle') alert("Too short to save");
        return;
    }
    
    try {
        let recs = JSON.parse(localStorage.getItem('hr_records')||'[]');
        const existingIndex = recs.findIndex(r => r.id === currentSession.id);
        
        const recordData = { 
            id: currentSession.id || Date.now(), 
            v: 1, // Versioning
            timestamp: currentSession.startTime || new Date().toISOString(), 
            bpm: Math.round(algoState.bpm)||'--', 
            data: state.history 
        };

        if (existingIndex >= 0) {
            // Update
            recs[existingIndex] = recordData;
        } else {
            // Insert New
            recs.unshift(recordData);
            if(recs.length > 10) recs.pop();
        }

        localStorage.setItem('hr_records', JSON.stringify(recs));
        renderList();
        saveBtn.innerText = "Saved";
        setTimeout(() => saveBtn.innerText = "Save", 1500);
    } catch(e) { 
        if(!appSettings.autoSave) alert("Storage full"); 
    }
}

function renderList() {
    const recs = JSON.parse(localStorage.getItem('hr_records')||'[]');
    storageInfo.innerText = (new Blob([JSON.stringify(recs)]).size/1024/1024).toFixed(2)+"MB";
    savedListContainer.innerHTML = '';
    if(!recs.length) return savedListContainer.appendChild(emptyState);
    
    recs.forEach(r => {
        const d = new Date(r.timestamp);
        const div = document.createElement('div');
        div.className = "bg-slate-800/80 p-3 rounded-lg border border-slate-700 hover:border-sky-500 cursor-pointer flex justify-between items-center transition-all active:scale-[0.98]";
        div.innerHTML = `
            <div>
                <div class="font-bold text-sky-400 text-xs">${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                <div class="text-[10px] text-slate-500">${d.toLocaleDateString()}</div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <div class="text-[9px] text-slate-500 uppercase">Avg BPM</div>
                    <div class="font-bold text-slate-200 text-sm">${r.bpm}</div>
                </div>
                <button class="del p-2 text-slate-500 hover:text-rose-400" data-id="${r.id}">✕</button>
            </div>`;
        div.onclick = (e) => {
            if(e.target.classList.contains('del')) {
                localStorage.setItem('hr_records', JSON.stringify(recs.filter(x=>x.id !== r.id)));
                renderList();
            } else {
                setMode('review');
                state.history = r.data;
                historySlider.min = Math.min(r.data.length, canvas.width);
                historySlider.max = r.data.length;
                historySlider.value = r.data.length;
                measuredBpmDisplay.innerText = r.bpm;
                measuredBpmDisplay.className = "text-4xl font-mono font-bold text-amber-500 tracking-tighter";
            }
        };
        savedListContainer.appendChild(div);
    });
}

// Loop
function loop(t) {
    if(!state.lastTime) state.lastTime = t;
    const dt = (t - state.lastTime)/1000;
    state.lastTime = t;

    if(state.mode === 'camera' || state.mode === 'simulate') {
        state.totalTime += dt;
        
        // Auto Stop Check
        if (appSettings.autoStopSeconds > 0 && state.totalTime >= appSettings.autoStopSeconds) {
            setMode('idle');
        } else {
            let s = state.mode === 'camera' ? processFrame() : generateSimulation(dt);
            const res = processAlgo(s, t);
            updateHistory(s, res.threshold, res.isBeat, Math.round(algoState.bpm), dt);
        }
    }
    draw();
    animationFrameId = requestAnimationFrame(loop);
}

function draw() {
    ctx.fillStyle = '#0f172a'; 
    ctx.fillRect(0,0,canvas.width,canvas.height); 
    
    let end = state.mode === 'review' ? state.reviewOffset : state.history.length;
    let start = Math.max(0, end - canvas.width);
    
    if(state.mode === 'review' && state.history.length) {
        const pt = state.history[Math.min(end, state.history.length-1)];
        if(pt) {
            measuredBpmDisplay.innerText = pt.bpm || '--';
            reviewTimeDisplay.innerText = `-${((state.history.length-end)/60).toFixed(1)}s`;
        }
    }

    const data = state.history.slice(start, end);
    if(!data.length) return;

    const cy = canvas.height/2;
    const sy = canvas.height/2.2;
    const my = v => cy - v*sy;

    // Grid
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.font = "9px monospace";
    for(let i=0; i<data.length; i++) {
        if(data[i].grid) {
            ctx.beginPath();
            ctx.strokeStyle = data[i].grid === 'major' ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.03)';
            ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke();
            if(data[i].label) {
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillText(data[i].label, i, canvas.height-2);
            }
        }
    }

    // Threshold
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,200,0,0.3)';
    ctx.setLineDash([4,4]);
    data.forEach((d,i) => i===0?ctx.moveTo(i,my(d.threshold)):ctx.lineTo(i,my(d.threshold)));
    ctx.stroke(); ctx.setLineDash([]);

    // Signal
    const color = state.mode==='simulate'?'#a855f7':(state.mode==='review'?'#f59e0b':'#ef4444');
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    data.forEach((d,i) => i===0?ctx.moveTo(i,my(d.val)):ctx.lineTo(i,my(d.val)));
    ctx.stroke();

    // Fill
    ctx.lineTo(data.length-1, canvas.height);
    ctx.lineTo(0, canvas.height);
    ctx.fillStyle = color + "20";
    ctx.fill();

    // Beats
    ctx.fillStyle = "#fff";
    data.forEach((d,i) => {
        if(d.beat) { ctx.beginPath(); ctx.arc(i, my(d.val), 3, 0, Math.PI*2); ctx.fill(); }
    });
}

// Modal Logic
function openSettings() {
    settingsModal.classList.remove('hidden');
    setTimeout(() => {
        settingsContent.classList.remove('scale-95', 'opacity-0');
        settingsContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeSettings() {
    saveSettings(); // Auto save on close
    settingsContent.classList.remove('scale-100', 'opacity-100');
    settingsContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => settingsModal.classList.add('hidden'), 200);
}

// Events
historySlider.addEventListener('input', e => { state.reviewOffset = parseInt(e.target.value); });
bpmSlider.addEventListener('input', e => { state.simBpm = parseInt(e.target.value); targetBpmDisplay.innerText = state.simBpm; });
cameraToggleBtn.onclick = () => setMode(state.mode==='camera'?'idle':'camera');
simulateBtn.onclick = () => setMode(state.mode==='simulate'?'idle':'simulate');
saveBtn.onclick = saveRec;
backToLiveBtn.onclick = () => setMode('idle');
exportJsonBtn.onclick = exportAllData;
exportImgBtn.onclick = exportGraphImage;

// Settings Events
settingsBtn.onclick = openSettings;
closeSettingsBtn.onclick = closeSettings;
settingsModal.onclick = (e) => { if(e.target === settingsModal) closeSettings(); };

// Lifecycle
document.addEventListener('visibilitychange', () => {
    if(document.hidden) {
        cancelAnimationFrame(animationFrameId);
        if(state.mode === 'camera') {
            stopCamera();
            setMode('idle'); 
        }
    } else {
        loop(performance.now());
    }
});
window.onpagehide = stopCamera;

// Init
loadSettings();
renderList();
loop(performance.now());

</script>
</body>
</html>
